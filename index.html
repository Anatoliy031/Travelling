<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover">
<title>–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–æ–≥–æ –∫—Ä–∞—è ‚Äî –¢–≤–æ–π –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ø—É—Ç–µ–≤–æ–¥–∏—Ç–µ–ª—å</title>
<meta name="description" content="–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≥–∏–¥ –ø–æ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–æ–º—É –∫—Ä–∞—é: –∫–∞—Ä—Ç–∞, —á—Ç–æ —Ä—è–¥–æ–º, –ª—É—á—à–∏–µ –º–µ—Å—Ç–∞, –º–∞—Ä—à—Ä—É—Ç—ã, –≤–∏–Ω–æ–¥–µ–≥—É—Å—Ç–∞—Ü–∏–∏, –º–æ—Ä–µ –∏ –≥–æ—Ä—ã.">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
<style>
:root{
  --bg:#0b0f14;--card:#111823;--ink:#e6edf5;--muted:#9fb0c3;--accent:#00B4F0;--accent-2:#4AC7F3;
  --ok:#27ae60;--warn:#f39c12;--bad:#e74c3c;--border:#223044;--chip:#172233;--chip-on:#0f5e7b;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
}
@media (prefers-color-scheme: light){
  :root{--bg:#f5f7fb;--card:#ffffff;--ink:#0b1a2b;--muted:#5f6b7a;--accent:#0077ff;--accent-2:#5bb8ff;--border:#e4eaf3;--chip:#eef3fb;--chip-on:#d9ecff;--shadow:0 12px 30px rgba(16,42,67,.08)}
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink);line-height:1.4}
a{color:var(--accent);text-decoration:none}
header{
  position:sticky;top:0;z-index:50;background:linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,0));
  backdrop-filter:saturate(140%) blur(10px);
}
.nav{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:14px;padding:12px 16px}
.brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px}
.brand .logo{width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:var(--shadow)}
.badge{background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
.main{max-width:1200px;margin:0 auto;padding:10px 16px 120px}
.hero{
  background:radial-gradient(1200px 400px at 50% -200px, rgba(0,180,240,.25), transparent), linear-gradient(180deg, rgba(0,0,0,.10), transparent);
  border:1px solid var(--border);border-radius:18px;padding:18px;box-shadow:var(--shadow);display:grid;gap:14px
}
.hero h1{font-size:26px;line-height:1.15;margin:0}
.hero p{margin:0;color:var(--muted)}
.controls{display:grid;gap:10px}
.searchbar{display:flex;gap:8px;flex-wrap:wrap}
.searchbar input{
  flex:1;min-width:180px;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--ink)
}
.btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--chip);padding:10px 14px;border-radius:12px;color:var(--ink);cursor:pointer}
.btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#00131b;border:none}
.btn.ghost{background:var(--card)}
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{padding:8px 12px;border-radius:999px;background:var(--chip);border:1px solid var(--border);color:var(--muted);cursor:pointer;font-weight:600}
.chip.active{background:var(--chip-on);color:#fff;border-color:transparent}
.layout{display:grid;grid-template-columns: 1.1fr .9fr;gap:16px;margin-top:14px}
@media(max-width:980px){.layout{grid-template-columns:1fr}.mapwrap{order:-1}}
.panel{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:var(--shadow)}
.panel header{position:unset;background:transparent;backdrop-filter:none}
.panel .head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border)}
.list{display:grid;gap:10px;padding:10px}
.card{
  display:grid;grid-template-columns:120px 1fr;gap:12px;border:1px solid var(--border);border-radius:14px;overflow:hidden;background:var(--card)
}
@media(max-width:560px){.card{grid-template-columns:1fr}}
.card img{width:100%;height:100%;max-height:160px;object-fit:cover}
.card-body{padding:10px 10px 12px}
.card h3{margin:0 0 6px 0;font-size:16px}
.meta{display:flex;flex-wrap:wrap;gap:8px;color:var(--muted);font-size:12px}
.tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.tag{background:var(--chip);color:var(--muted);border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px}
.actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.kpi{display:flex;gap:18px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-top:8px}
.kpi b{color:var(--ink)}
.mapwrap{position:sticky;top:76px;height:calc(100vh - 100px);min-height:420px}
#map{width:100%;height:100%;border-radius:16px;border:1px solid var(--border);overflow:hidden}
.footerbar{
  position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.6));
  padding:12px;z-index:60
}
.route{
  max-width:1200px;margin:0 auto;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:10px;box-shadow:var(--shadow);
  display:grid;gap:10px
}
.route .title{display:flex;align-items:center;gap:10px}
.stops{display:flex;overflow:auto;gap:8px;padding-bottom:4px}
.stop{min-width:180px;border:1px dashed var(--border);padding:8px;border-radius:10px;display:grid;gap:6px;background:var(--chip)}
.stop .row{display:flex;justify-content:space-between;gap:8px;align-items:center}
.stop .small{font-size:12px;color:var(--muted)}
.stop .del{border:none;background:transparent;color:var(--bad);cursor:pointer}
.route .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
label.slider{display:flex;align-items:center;gap:8px;color:var(--muted)}
label.slider input{accent-color:var(--accent)}
.toast{
  position:fixed;inset:auto 16px 86px auto;background:var(--card);border:1px solid var(--border);padding:10px 12px;border-radius:10px;
  box-shadow:var(--shadow);color:var(--ink);font-size:13px;z-index:70;display:none
}
.empty{padding:24px;color:var(--muted)}
hr.sep{border:none;border-top:1px dashed var(--border);margin:8px 0}
</style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand"><div class="logo"></div><div>–ö—Ä–∞–π –ì–∏–¥</div><span class="badge">–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π</span></div>
    <div style="flex:1"></div>
    <button class="btn ghost" id="btn-share" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø–æ–¥–±–æ—Ä–∫–æ–π">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
    <button class="btn ghost" id="btn-favs" title="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ <span id="fav-count" class="badge" style="margin-left:6px">0</span></button>
  </div>
</header>

<main class="main">
  <section class="hero">
    <div>
      <h1>–õ—É—á—à–∏–µ –º–µ—Å—Ç–∞ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–æ–≥–æ –∫—Ä–∞—è: –º–æ—Ä–µ, –≥–æ—Ä—ã, –≤–∏–Ω–æ –∏ –∞–¥—Ä–µ–Ω–∞–ª–∏–Ω</h1>
      <p>–ù–∞–π–¥–∏, —á—Ç–æ —Ä—è–¥–æ–º, —Å–æ–±–µ—Ä–∏ –º–∞—Ä—à—Ä—É—Ç –≤ –æ–¥–∏–Ω —Ç–∞–ø –∏ –ø–æ–µ–∑–∂–∞–π. –í—Å—ë ‚Äî –Ω–∞ –æ–¥–Ω–æ–π –∫–∞—Ä—Ç–µ.</p>
    </div>
    <div class="controls">
      <div class="searchbar">
        <input id="q" type="search" placeholder="–ü–æ–∏—Å–∫: ¬´–°–∞—Ñ–∞—Ä–∏-–ø–∞—Ä–∫¬ª, ¬´–†–æ–∑–∞ –•—É—Ç–æ—Ä¬ª, ¬´–≤–∏–Ω–æ¬ª, ¬´–≤–æ–¥–æ–ø–∞–¥—ã¬ª, ¬´—Å–µ–º—å—è¬ª‚Ä¶">
        <button class="btn" id="btn-locate">üìç –†—è–¥–æ–º —Å–æ –º–Ω–æ–π</button>
        <button class="btn primary" id="btn-reset">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
      </div>
      <div class="chips" id="chips"></div>
      <div class="searchbar">
        <label class="slider">–†–∞–¥–∏—É—Å (–∫–º –æ—Ç –º–µ–Ω—è): <b id="rad-val">100</b>
          <input id="radius" type="range" min="5" max="400" step="5" value="100">
        </label>
        <label class="slider">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:
          <select id="sort">
            <option value="distance">–ü–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é</option>
            <option value="rating">–ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É</option>
            <option value="popularity">–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏</option>
            <option value="name">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
          </select>
        </label>
      </div>
    </div>
  </section>

  <section class="layout">
    <div class="panel">
      <div class="head">
        <div style="font-weight:700">–ö–∞—Ç–∞–ª–æ–≥ –º–µ—Å—Ç</div>
        <div style="display:flex;gap:8px;align-items:center;color:var(--muted)">
          <span id="count">0</span> –º–µ—Å—Ç ¬∑ <span id="near">–Ω–µ—Ç –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏</span>
        </div>
      </div>
      <div class="list" id="list"></div>
    </div>
    <div class="mapwrap panel">
      <div id="map"></div>
    </div>
  </section>
</main>

<div class="footerbar">
  <div class="route">
    <div class="title"><b>–ú–∞—Ä—à—Ä—É—Ç</b> <span id="route-stats" class="badge">–ø—É—Å—Ç–æ</span></div>
    <div class="stops" id="stops"></div>
    <div class="row">
      <button class="btn" id="btn-opt">–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫</button>
      <button class="btn" id="btn-clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
      <div style="flex:1"></div>
      <button class="btn" id="btn-ymaps">–û—Ç–∫—Ä—ã—Ç—å –≤ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞—Ö</button>
      <button class="btn" id="btn-gmaps">–û—Ç–∫—Ä—ã—Ç—å –≤ Google Maps</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
<script>
/* ------------ –î–ê–ù–ù–´–ï ------------- */
const CATEGORIES = [
  {id:'sea', label:'–ú–æ—Ä–µ/–ø–ª—è–∂–∏'}, {id:'mountain', label:'–ì–æ—Ä—ã/–≤–∏–¥–æ–≤—ã–µ'},
  {id:'nature', label:'–ü—Ä–∏—Ä–æ–¥–∞/–≤–æ–¥–æ–ø–∞–¥—ã'}, {id:'adventure', label:'–≠–∫—Å—Ç—Ä–∏–º/–ø–∞—Ä–∫–∏'},
  {id:'wine', label:'–í–∏–Ω–æ/–¥–µ–≥—É—Å—Ç–∞—Ü–∏–∏'}, {id:'culture', label:'–ö—É–ª—å—Ç—É—Ä–∞/–ø–∞—Ä–∫–∏'},
  {id:'family', label:'–°–µ–º—å—è/–¥–µ—Ç—è–º'}, {id:'city', label:'–ì–æ—Ä–æ–¥/—Å–∫–≤–µ—Ä—ã'}
];

const ATTRACTIONS = [
  {id:1,name:'–ü–∞—Ä–∫ ¬´–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä¬ª',city:'–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä',lat:45.0445,lon:39.0137,
   cats:['city','family','culture'], rating:4.9,pop:99, price:'–±–µ—Å–ø–ª–∞—Ç–Ω–æ',
   img:'https://images.unsplash.com/photo-1564410267848-db70534a26a4?auto=format&fit=crop&w=1200&q=60',
   desc:'–ò–∫–æ–Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –ø–∞—Ä–∫–æ–≤–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞: –∞–º—Ñ–∏—Ç–µ–∞—Ç—Ä—ã, —Ñ–æ–Ω—Ç–∞–Ω—ã, –º–µ–¥–∏–∞-—ç–∫—Ä–∞–Ω, –¥–µ–Ω–¥—Ä–æ—Å–∞–¥.',
   partner:null},
  {id:2,name:'–ê–±—Ä–∞—É-–î—é—Ä—Å–æ –∏ –æ–∑–µ—Ä–æ –ê–±—Ä–∞—É',city:'–ù–æ–≤–æ—Ä–æ—Å—Å–∏–π—Å–∫',lat:44.7039,lon:37.5828,
   cats:['wine','nature','family'], rating:4.8,pop:95, price:'–±–∏–ª–µ—Ç—ã/–¥–µ–≥—É—Å—Ç–∞—Ü–∏–∏',
   img:'https://images.unsplash.com/photo-1532635210-d02b640c32df?auto=format&fit=crop&w=1200&q=60',
   desc:'–¶–µ–Ω—Ç—Ä —Ä—É—Å—Å–∫–æ–≥–æ —à–∞–º–ø–∞–Ω—Å–∫–æ–≥–æ, –ø—Ä–æ–≥—É–ª–∫–∏ –ø–æ –æ–∑–µ—Ä—É, –≥–∞—Å—Ç—Ä–æ–Ω–æ–º–∏—è –∏ –≤–∏–Ω–Ω—ã–µ —Ç—É—Ä—ã.',
   partner:{label:'–í–∏–Ω–Ω—ã–π —Ç—É—Ä', url:'https://yandex.ru/maps/?text=%D0%90%D0%B1%D1%80%D0%B0%D1%83%20%D0%B4%D1%8E%D1%80%D1%81%D0%BE'}},
  {id:3,name:'–ó–∞–ø–æ–≤–µ–¥–Ω–∏–∫ –ë–æ–ª—å—à–æ–π –£—Ç—Ä–∏—à',city:'–ê–Ω–∞–ø–∞',lat:44.8278,lon:37.4392,
   cats:['sea','nature'], rating:4.7,pop:88, price:'–≤—Ö–æ–¥–Ω–æ–π',
   img:'https://images.unsplash.com/photo-1505761671935-60b3a7427bad?auto=format&fit=crop&w=1200&q=60',
   desc:'–õ–∞–≥—É–Ω—ã, –º–æ–∂–∂–µ–≤–µ–ª–æ–≤—ã–µ —Ä–æ—â–∏ –∏ –±–∏—Ä—é–∑–æ–≤—ã–µ –±—É—Ö—Ç—ã. –°–Ω–æ—Ä–∫–ª–∏–Ω–≥ –∏ —Ç—Ä–µ–∫–∫–∏–Ω–≥.',
   partner:null},
  {id:4,name:'–û–∑–µ—Ä–æ –°—É–∫–∫–æ (–∫–∏–ø–∞—Ä–∏—Å—ã –≤ –≤–æ–¥–µ)',city:'–ê–Ω–∞–ø–∞',lat:44.7762,lon:37.4844,
   cats:['nature','family'], rating:4.7,pop:91, price:'–±–µ—Å–ø–ª–∞—Ç–Ω–æ',
   img:'https://images.unsplash.com/photo-1520086846052-d4c83634ed71?auto=format&fit=crop&w=1200&q=60',
   desc:'–ó–Ω–∞–º–µ–Ω–∏—Ç—ã–µ –∑–∞—Ç–æ–ø–ª–µ–Ω–Ω—ã–µ –∫–∏–ø–∞—Ä–∏—Å—ã. –õ—É—á—à–∏–µ –∫–∞–¥—Ä—ã ‚Äî –æ—Å–µ–Ω—å—é.',
   partner:null},
  {id:5,name:'–°–∞—Ñ–∞—Ä–∏-–ø–∞—Ä–∫ –ì–µ–ª–µ–Ω–¥–∂–∏–∫',city:'–ì–µ–ª–µ–Ω–¥–∂–∏–∫',lat:44.5659,lon:38.1098,
   cats:['family','adventure'], rating:4.6,pop:92, price:'–±–∏–ª–µ—Ç—ã',
   img:'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=60',
   desc:'–ö–∞–Ω–∞—Ç–Ω–∞—è –¥–æ—Ä–æ–≥–∞, –ø–∞–Ω–æ—Ä–∞–º—ã –±—É—Ö—Ç—ã, —Ä–µ–∞–±–∏–ª–∏—Ç–∞—Ü–∏—è –∂–∏–≤–æ—Ç–Ω—ã—Ö.',
   partner:{label:'–ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç',url:'https://yandex.ru/maps/?text=%D0%A1%D0%B0%D1%84%D0%B0%D1%80%D0%B8%20%D0%BF%D0%B0%D1%80%D0%BA%20%D0%93%D0%B5%D0%BB%D0%B5%D0%BD%D0%B4%D0%B6%D0%B8%D0%BA'}},
  {id:6,name:'–°–∫–∞–ª–∞ –ü–∞—Ä—É—Å',city:'–ü—Ä–∞—Å–∫–æ–≤–µ–µ–≤–∫–∞',lat:44.4985,lon:37.9883,
   cats:['sea','nature'], rating:4.6,pop:83, price:'–±–µ—Å–ø–ª–∞—Ç–Ω–æ',
   img:'https://images.unsplash.com/photo-1469474968028-56623f02e42e?auto=format&fit=crop&w=1200&q=60',
   desc:'–í–∏–∑–∏—Ç–∫–∞ –ø–æ–±–µ—Ä–µ–∂—å—è: —É–∑–∫–∞—è –∫–∞–º–µ–Ω–Ω–∞—è –∞—Ä–∫–∞ —É —Å–∞–º–æ–π –∫—Ä–æ–º–∫–∏ –º–æ—Ä—è.',
   partner:null},
  {id:7,name:'–°—Ç–∞—Ä—ã–π –ø–∞—Ä–∫',city:'–ö–∞–±–∞—Ä–¥–∏–Ω–∫–∞',lat:44.6497,lon:37.9348,
   cats:['culture','family'], rating:4.7,pop:80, price:'–±–∏–ª–µ—Ç—ã',
   img:'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?auto=format&fit=crop&w=1200&q=60',
   desc:'–ê–≤—Ç–æ—Ä—Å–∫–∏–π —ç—Ç–Ω–æ–ø–∞—Ä–∫: –∞–Ω—Ç–∏—á–Ω–æ—Å—Ç—å, —Å—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤—å–µ, –í–æ—Å—Ç–æ–∫ ‚Äî –Ω–∞ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–π —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏.',
   partner:null},
  {id:8,name:'–î–æ–ª–∏–Ω–∞ –ª–æ—Ç–æ—Å–æ–≤ (–ê—Ö—Ç–∞–Ω–∏–∑–æ–≤—Å–∫–∏–π –ª–∏–º–∞–Ω)',city:'–¢–µ–º—Ä—é–∫',lat:45.2722,lon:37.1530,
   cats:['nature','sea'], rating:4.6,pop:77, price:'–ø—Ä–æ–≥—É–ª–∫–∞/–∫–∞—Ç–µ—Ä',
   img:'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1200&q=60',
   desc:'–õ–æ—Ç–æ—Å—ã —Ü–≤–µ—Ç—É—Ç –≤ –∏—é–ª–µ‚Äì–∞–≤–≥—É—Å—Ç–µ. –í–æ–¥–Ω—ã–µ –ø—Ä–æ–≥—É–ª–∫–∏ –ø–æ –∫–∞–Ω–∞–ª–∞–º –ª–∏–º–∞–Ω–∞.',
   partner:null},
  {id:9,name:'–ì—Ä—è–∑–µ–≤–æ–π –≤—É–ª–∫–∞–Ω –¢–∏–∑–¥–∞—Ä',city:'–¢–µ–º—Ä—é–∫',lat:45.2389,lon:36.9881,
   cats:['adventure','nature'], rating:4.5,pop:75, price:'–±–∏–ª–µ—Ç—ã',
   img:'https://images.unsplash.com/photo-1499696010180-025efef15781?auto=format&fit=crop&w=1200&q=60',
   desc:'–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≥—Ä—è–∑–µ–≤—ã–µ –≤–∞–Ω–Ω—ã —Å –≤–∏–¥–æ–º –Ω–∞ –¢–∞–º–∞–Ω—å –∏ –º–æ—Ä–µ.',
   partner:null},
  {id:10,name:'–î–æ–ª–∏–Ω–∞ –õ–µ—Ñ–∫–∞–¥–∏—è (–≤–∏–Ω–æ–¥–µ–ª—å–Ω—è)',city:'–ö—Ä—ã–º—Å–∫',lat:44.8744,lon:38.4187,
   cats:['wine','nature','family'], rating:4.8,pop:82, price:'–¥–µ–≥—É—Å—Ç–∞—Ü–∏–∏',
   img:'https://images.unsplash.com/photo-1506354666786-959d6d497f1a?auto=format&fit=crop&w=1200&q=60',
   desc:'–°–∞–¥—ã, —ç–Ω–æ—Ç—É—Ä–∏–∑–º, –º—É–∑–µ–π –≤–∏–Ω–∞. –û—Ç–ª–∏—á–Ω—ã–π —É–∏–∫–µ–Ω–¥ –¥–ª—è –≥—É—Ä–º–∞–Ω–æ–≤.',
   partner:{label:'–¢—É—Ä/–¥–µ–≥—É—Å—Ç–∞—Ü–∏—è',url:'https://yandex.ru/maps/?text=%D0%9B%D0%B5%D1%84%D0%BA%D0%B0%D0%B4%D0%B8%D1%8F'}},
  {id:11,name:'–ì–æ—Ä–Ω—ã–π –∫—É—Ä–æ—Ä—Ç ¬´–†–æ–∑–∞ –•—É—Ç–æ—Ä¬ª',city:'–°–æ—á–∏ (–ö—Ä–∞—Å–Ω–∞—è –ü–æ–ª—è–Ω–∞)',lat:43.67,lon:40.2065,
   cats:['mountain','adventure','family'], rating:4.8,pop:98, price:'–ø–æ–¥—ä—ë–º–Ω–∏–∫–∏/–ø–∞—Å—Å',
   img:'https://images.unsplash.com/photo-1541844053589-346841d0d3a8?auto=format&fit=crop&w=1200&q=60',
   desc:'–ö–∞–Ω–∞—Ç–∫–∏, –≤–∏–¥–æ–≤—ã–µ —Ç—Ä–æ–ø—ã, –º–∞—Ä—à—Ä—É—Ç—ã –Ω–∞ –≤–µ—Å—å –≥–æ–¥. –°–µ—Ä–¥—Ü–µ –ü–æ–ª—è–Ω—ã.',
   partner:{label:'–°–∫–∏-–ø–∞—Å—Å—ã/–ª–µ—Ç–Ω–∏–µ –±–∏–ª–µ—Ç—ã',url:'https://yandex.ru/maps/?text=%D0%A0%D0%BE%D0%B7%D0%B0%20%D0%A5%D1%83%D1%82%D0%BE%D1%80'}},
  {id:12,name:'–û–ª–∏–º–ø–∏–π—Å–∫–∏–π –ø–∞—Ä–∫',city:'–°–æ—á–∏ (–ò–º–µ—Ä–µ—Ç–∏–Ω–∫–∞)',lat:43.4020,lon:39.9550,
   cats:['family','culture','city'], rating:4.7,pop:90, price:'—á–∞—Å—Ç–∏—á–Ω–æ –ø–ª–∞—Ç–Ω–æ',
   img:'https://images.unsplash.com/photo-1518084823714-b8570d3d2a3a?auto=format&fit=crop&w=1200&q=60',
   desc:'–ü—Ä–æ–≥—É–ª–∫–∏ –≤–¥–æ–ª—å –∞—Ä–µ–Ω –∏ –Ω–∞–±–µ—Ä–µ–∂–Ω–æ–π, –≤–µ—á–µ—Ä–Ω–∏–µ —à–æ—É —Ñ–æ–Ω—Ç–∞–Ω–æ–≤.',
   partner:null},
  {id:13,name:'Skypark AJ Hackett',city:'–°–æ—á–∏ (–ú–∑—ã–º—Ç–∞)',lat:43.5329,lon:39.9805,
   cats:['adventure','mountain'], rating:4.7,pop:85, price:'–∞—Ç—Ç—Ä–∞–∫—Ü–∏–æ–Ω—ã',
   img:'https://images.unsplash.com/photo-1533105079780-92b9be482077?auto=format&fit=crop&w=1200&q=60',
   desc:'–ü–æ–¥–≤–µ—Å–Ω–æ–π –º–æ—Å—Ç, –±–∞–Ω–¥–∂–∏-–¥–∂–∞–º–ø–∏–Ω–≥ –∏ –≤–∏–¥ –Ω–∞ –∫–∞–Ω—å–æ–Ω—ã.',
   partner:null},
  {id:14,name:'–°–æ—á–∏–Ω—Å–∫–∏–π –¥–µ–Ω–¥—Ä–∞—Ä–∏–π',city:'–°–æ—á–∏',lat:43.5812,lon:39.7285,
   cats:['culture','family','nature'], rating:4.7,pop:86, price:'–±–∏–ª–µ—Ç—ã',
   img:'https://images.unsplash.com/photo-1558980664-10b1b13a1b06?auto=format&fit=crop&w=1200&q=60',
   desc:'–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –ø–∞—Ä–∫ —Å –∫–∞–Ω–∞—Ç–Ω–æ–π –¥–æ—Ä–æ–≥–æ–π –∏ –∫–æ–ª–ª–µ–∫—Ü–∏–µ–π —ç–∫–∑–æ—Ç–æ–≤.',
   partner:null},
  {id:15,name:'–ê–≥—É—Ä—Å–∫–∏–µ –≤–æ–¥–æ–ø–∞–¥—ã',city:'–°–æ—á–∏',lat:43.5434,lon:39.8576,
   cats:['nature','mountain'], rating:4.6,pop:84, price:'—ç–∫–æ—Ç—Ä–æ–ø–∞',
   img:'https://images.unsplash.com/photo-1520975922203-bc1ae19d01df?auto=format&fit=crop&w=1200&q=60',
   desc:'–ö–∞—Å–∫–∞–¥—ã –≤ —Ç–µ—Å–Ω–∏–Ω–µ, —Ä—è–¥–æ–º ‚Äî –û—Ä–ª–∏–Ω—ã–µ —Å–∫–∞–ª—ã –∏ –≤–∏–¥ –Ω–∞ –º–æ—Ä–µ.',
   partner:null},
  {id:16,name:'33 –≤–æ–¥–æ–ø–∞–¥–∞',city:'–°–æ—á–∏ (–ö–∏—á–º–∞–π)',lat:43.8297,lon:39.3923,
   cats:['nature','family'], rating:4.6,pop:80, price:'—ç–∫–æ—Ç—Ä–æ–ø–∞',
   img:'https://images.unsplash.com/photo-1513836279014-a89f7a76ae86?auto=format&fit=crop&w=1200&q=60',
   desc:'–ú–∞—Ä—à—Ä—É—Ç –ø–æ –¥–µ—Ä–µ–≤—è–Ω–Ω—ã–º –Ω–∞—Å—Ç–∏–ª–∞–º –≤–¥–æ–ª—å –∫–∞—Å–∫–∞–¥–æ–≤ —Ä–µ–∫–∏ –î–∂–µ–≥–æ—à.',
   partner:null},
  {id:17,name:'–ì–æ—Ä–∞ –ê—Ö—É–Ω –∏ –±–∞—à–Ω—è',city:'–°–æ—á–∏',lat:43.5234,lon:39.8689,
   cats:['mountain','nature'], rating:4.7,pop:83, price:'–±–∏–ª–µ—Ç—ã –Ω–∞ –±–∞—à–Ω—é',
   img:'https://images.unsplash.com/photo-1520975693416-35a4f7b5b2ab?auto=format&fit=crop&w=1200&q=60',
   desc:'–õ—É—á—à–∏–µ —Å–º–æ—Ç—Ä–æ–≤—ã–µ —Å–æ—á–∏–Ω—Å–∫–æ–≥–æ –ø–æ–±–µ—Ä–µ–∂—å—è.',
   partner:null},
  {id:18,name:'–¢–∏—Å–æ-—Å–∞–º—à–∏—Ç–æ–≤–∞—è —Ä–æ—â–∞ (–•–æ—Å—Ç–∞)',city:'–°–æ—á–∏',lat:43.5226,lon:39.8609,
   cats:['nature'], rating:4.7,pop:79, price:'—ç–∫–æ—Ç—Ä–æ–ø–∞',
   img:'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?auto=format&fit=crop&w=1200&q=60',
   desc:'–†–µ–ª–∏–∫—Ç–æ–≤—ã–µ –ª–µ—Å–∞, –∫–∞–Ω—å–æ–Ω—ã –∏ –≤–∏—Å—è—á–∏–µ –º—Ö–∏.',
   partner:null},
  {id:19,name:'–ö–∞–Ω—å–æ–Ω —Ä–µ–∫–∏ –ü—Å–∞—Ö–æ',city:'–°–æ—á–∏',lat:43.5486,lon:39.8349,
   cats:['nature','adventure'], rating:4.6,pop:78, price:'—ç–∫–æ—Ç—Ä–æ–ø–∞',
   img:'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?auto=format&fit=crop&w=1200&q=60',
   desc:'–ò–∑—É–º—Ä—É–¥–Ω—ã–µ –≤–∞–Ω–Ω—ã –∏ –∫–∞—Ä—Å—Ç–æ–≤—ã–µ –≥–∞–ª–µ—Ä–µ–∏.',
   partner:null},
  {id:20,name:'–ì—É–∞–º—Å–∫–æ–µ —É—â–µ–ª—å–µ (—É–∑–∫–æ–∫–æ–ª–µ–π–∫–∞)',city:'–ê–ø—à–µ—Ä–æ–Ω—Å–∫',lat:44.2289,lon:39.3818,
   cats:['nature','adventure','mountain'], rating:4.7,pop:81, price:'–∂/–¥ –º–∞—Ä—à—Ä—É—Ç',
   img:'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=60',
   desc:'–ü–æ–µ–∑–¥ –≤–¥–æ–ª—å –æ—Ç–≤–µ—Å–Ω—ã—Ö —Å–∫–∞–ª –∏ —Ä–µ–∫–∏ –ö—É—Ä–¥–∂–∏–ø—Å.',
   partner:null},
  {id:21,name:'–°–∫–∞–ª–∞ –ö–∏—Å–µ–ª—ë–≤–∞',city:'–¢—É–∞–ø—Å–µ',lat:44.0626,lon:39.0833,
   cats:['sea','nature'], rating:4.6,pop:72, price:'–±–µ—Å–ø–ª–∞—Ç–Ω–æ',
   img:'https://images.unsplash.com/photo-1487537708572-3c850b5e856e?auto=format&fit=crop&w=1200&q=60',
   desc:'–°—ä—ë–º–æ—á–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è ‚Äú–ë—Ä–∏–ª–ª–∏–∞–Ω—Ç–æ–≤–æ–π —Ä—É–∫–∏‚Äù.',
   partner:null},
  {id:22,name:'–î–æ–ª—å–º–µ–Ω—ã –¥–æ–ª–∏–Ω—ã –ñ–∞–Ω–µ',city:'–ì–µ–ª–µ–Ω–¥–∂–∏–∫',lat:44.4868,lon:38.2211,
   cats:['culture','nature'], rating:4.5,pop:70, price:'–≤—Ö–æ–¥–Ω–æ–π',
   img:'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=60',
   desc:'–ú–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –º–µ–≥–∞–ª–∏—Ç—ã –∏ –≤–æ–¥–æ–ø–∞–¥—ã –ø–æ –ø—É—Ç–∏.',
   partner:null},
  {id:23,name:'–í–∏–Ω–æ–¥–µ–ª—å–Ω—è –ú—ã—Å—Ö–∞–∫–æ',city:'–ù–æ–≤–æ—Ä–æ—Å—Å–∏–π—Å–∫',lat:44.6686,lon:37.7188,
   cats:['wine','sea'], rating:4.7,pop:76, price:'–¥–µ–≥—É—Å—Ç–∞—Ü–∏–∏',
   img:'https://images.unsplash.com/photo-1470145318698-cb03732f5ddf?auto=format&fit=crop&w=1200&q=60',
   desc:'–í–∏–¥—ã –Ω–∞ –¶–µ–º–µ—Å—Å–∫—É—é –±—É—Ö—Ç—É –∏ –≥–∞—Å—Ç—Ä–æ-—Ç–µ—Ä—Ä–∞—Å—ã.',
   partner:null},
  {id:24,name:'–ì–æ–ª—É–±–∞—è –±—É—Ö—Ç–∞',city:'–ì–µ–ª–µ–Ω–¥–∂–∏–∫',lat:44.5232,lon:38.0475,
   cats:['sea','family'], rating:4.6,pop:74, price:'–±–µ—Å–ø–ª–∞—Ç–Ω–æ',
   img:'https://images.unsplash.com/photo-1505761671935-60b3a7427bad?auto=format&fit=crop&w=1200&q=60',
   desc:'–£–∫—Ä–æ–º–Ω—ã–µ –ø–ª—è–∂–∏ –∏ —Ö–≤–æ–π–Ω—ã–π –≤–æ–∑–¥—É—Ö.',
   partner:null},
  {id:25,name:'–ù–∞–≤–∞–ª–∏—â–µ–Ω—Å–∫–æ–µ —É—â–µ–ª—å–µ',city:'–°–æ—á–∏ (–•–æ—Å—Ç–∞)',lat:43.5668,lon:39.7883,
   cats:['nature','adventure'], rating:4.5,pop:68, price:'—ç–∫–æ—Ç—Ä–æ–ø–∞',
   img:'https://images.unsplash.com/photo-1520975922203-bc1ae19d01df?auto=format&fit=crop&w=1200&q=60',
   desc:'–õ—ë–≥–∫–∏–π —Ç—Ä–µ–∫ –≤ —Ç–µ–Ω–∏ —Å–∞–º—à–∏—Ç–∞ –∏ —Ç–∏—Å–∞.',
   partner:null}
];

/* ------------ –£–¢–ò–õ–ò–¢–´ ------------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const km = d => (d).toFixed(1)+' –∫–º';
function haversine(a,b){ // km
  const R=6371, toRad=x=>x*Math.PI/180;
  const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);
  const s=Math.sin(dLat/2)**2+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));
}
function toast(msg, ms=2200){const t=$("#toast");t.textContent=msg;t.style.display='block';clearTimeout(t._to);t._to=setTimeout(()=>t.style.display='none',ms);}

/* ------------ –°–û–°–¢–û–Ø–ù–ò–ï ------------- */
let userPos=null; // {lat,lon}
let activeCats=new Set(); // chips
let query=''; let radius=100;
let sortMode='distance';
let markers=[]; let map; let layer;

const favs = new Set(JSON.parse(localStorage.getItem('kk-favs')||'[]'));
const route = JSON.parse(localStorage.getItem('kk-route')||'[]'); // ids[]

/* ------------ –ò–ù–ò–¢ UI ------------- */
function buildChips(){
  const wrap=$("#chips"); wrap.innerHTML='';
  CATEGORIES.forEach(c=>{
    const el=document.createElement('button');
    el.className='chip'; el.textContent=c.label; el.dataset.id=c.id;
    el.onclick=()=>{ 
      if(activeCats.has(c.id)) activeCats.delete(c.id); else activeCats.add(c.id);
      el.classList.toggle('active');
      renderAll();
    };
    wrap.appendChild(el);
  });
}
function buildMap(){
  map=L.map('map',{scrollWheelZoom:true}).setView([44.9,38.7],8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19, attribution:'¬© OpenStreetMap'
  }).addTo(map);
  layer=L.layerGroup().addTo(map);
}

/* ------------ –§–ò–õ–¨–¢–†/–°–û–†–¢ ------------ */
function filterData(){
  let data=[...ATTRACTIONS];
  if(query){
    const q=query.toLowerCase();
    data=data.filter(x=> (x.name+x.city+x.desc+x.cats.join(',')).toLowerCase().includes(q));
  }
  if(activeCats.size) data=data.filter(x=> x.cats.some(c=>activeCats.has(c)));
  if(userPos){ data.forEach(x=> x._d=haversine(userPos,{lat:x.lat,lon:x.lon})); }
  else { data.forEach(x=> x._d=Infinity); }
  if(userPos) data=data.filter(x=> x._d<=radius);
  data.sort((a,b)=>{
    if(sortMode==='distance') return (a._d)-(b._d);
    if(sortMode==='rating') return (b.rating)-(a.rating);
    if(sortMode==='popularity') return (b.pop)-(a.pop);
    if(sortMode==='name') return a.name.localeCompare(b.name,'ru');
    return 0;
  });
  return data;
}

/* ------------ –†–ï–ù–î–ï–† –°–ü–ò–°–ö–ê ------------ */
function renderList(data){
  const wrap=$("#list"); wrap.innerHTML='';
  if(!data.length){wrap.innerHTML=`<div class="empty">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ —Ä–∞—Å—à–∏—Ä–∏—Ç—å —Ä–∞–¥–∏—É—Å.</div>`; return}
  data.forEach(x=>{
    const fav=favs.has(x.id);
    const inRoute=route.includes(x.id);
    const d = Number.isFinite(x._d)? km(x._d): '‚Äî';
    const card=document.createElement('article');
    card.className='card';
    card.innerHTML=`
      <img src="${x.img}" alt="${x.name}" loading="lazy">
      <div class="card-body">
        <h3>${x.name}</h3>
        <div class="meta">
          <span>üìç ${x.city}</span>
          <span>‚≠ê ${x.rating.toFixed(1)}</span>
          <span>üìè ${d}</span>
        </div>
        <div class="tags">${x.cats.map(c=>`<span class="tag">#${c}</span>`).join('')}</div>
        <div class="kpi"><span>–°—Ç–æ–∏–º–æ—Å—Ç—å: <b>${x.price}</b></span><span>–ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å: <b>${x.pop}</b></span></div>
        <div class="actions">
          <button class="btn" data-act="route">${inRoute?'–í –º–∞—Ä—à—Ä—É—Ç–µ ‚úÖ':'–í –º–∞—Ä—à—Ä—É—Ç'}</button>
          <button class="btn ghost" data-act="nav">–ú–∞—Ä—à—Ä—É—Ç –∫ –º–µ—Å—Ç—É</button>
          ${x.partner?`<a class="btn primary" href="${x.partner.url}" target="_blank" rel="noopener">${x.partner.label}</a>`:''}
          <button class="btn ghost" data-act="fav">${fav?'‚òÖ –í –∏–∑–±—Ä–∞–Ω–Ω–æ–º':'‚òÜ –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}</button>
          <button class="btn ghost" data-act="more">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
        </div>
        <div class="more" style="display:none;margin-top:8px;color:var(--muted)">${x.desc}</div>
      </div>`;
    card.querySelector('[data-act="more"]').onclick=()=>card.querySelector('.more').style.display='block';
    card.querySelector('[data-act="fav"]').onclick=()=>{
      if(favs.has(x.id)) favs.delete(x.id); else favs.add(x.id);
      localStorage.setItem('kk-favs',JSON.stringify([...favs]));
      renderAll(); toast('–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
    };
    card.querySelector('[data-act="route"]').onclick=()=>{
      const idx=route.indexOf(x.id);
      if(idx>=0) route.splice(idx,1); else route.push(x.id);
      localStorage.setItem('kk-route',JSON.stringify(route));
      renderAll(); toast('–ú–∞—Ä—à—Ä—É—Ç –æ–±–Ω–æ–≤–ª—ë–Ω');
    };
    card.querySelector('[data-act="nav"]').onclick=()=>{
      openSingleNav(x);
    };
    wrap.appendChild(card);
  });
  $("#count").textContent=data.length;
}

/* ------------ –ö–ê–†–¢–ê ------------ */
function renderMap(data){
  layer.clearLayers(); markers=[];
  const bounds=[];
  data.forEach(x=>{
    const m=L.marker([x.lat,x.lon]).addTo(layer).bindPopup(
      `<b>${x.name}</b><br>${x.city}<br>‚≠ê ${x.rating.toFixed(1)}${Number.isFinite(x._d)?` ¬∑ ${km(x._d)}`:''}<br>
       <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">
         <a href="#" data-id="${x.id}" data-what="add" class="lnk">–í –º–∞—Ä—à—Ä—É—Ç</a>
         <a href="#" data-id="${x.id}" data-what="nav" class="lnk">–ù–∞–≤–∏–≥–∞—Ç–æ—Ä</a>
       </div>`
    );
    m.on('popupopen',e=>{
      const el=e.popup.getElement();
      el.querySelectorAll('a.lnk').forEach(a=>{
        a.onclick=(ev)=>{
          ev.preventDefault();
          const id=+a.dataset.id; const item=ATTRACTIONS.find(z=>z.id===id);
          if(a.dataset.what==='add'){
            if(!route.includes(id)) route.push(id);
            localStorage.setItem('kk-route',JSON.stringify(route));
            renderAll(); toast('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –º–∞—Ä—à—Ä—É—Ç');
          }else if(a.dataset.what==='nav'){ openSingleNav(item); }
        };
      });
    });
    markers.push(m); bounds.push([x.lat,x.lon]);
  });
  if(bounds.length) map.fitBounds(bounds,{padding:[20,20]});
  if(userPos){
    const userMarker=L.circleMarker([userPos.lat,userPos.lon],{radius:8,color:'#00b4f0',fillOpacity:.8}).addTo(layer).bindTooltip('–í—ã –∑–¥–µ—Å—å');
    bounds.push([userPos.lat,userPos.lon]);
  }
}

/* ------------ –ú–ê–†–®–†–£–¢ ------------ */
function renderRoute(){
  const box=$("#stops"); box.innerHTML='';
  const items=route.map(id=>ATTRACTIONS.find(x=>x.id===id)).filter(Boolean);
  let total=0;
  if(items.length){
    for(let i=0;i<items.length;i++){
      const a=items[i], b=items[i+1]; if(b) total+=haversine(a,b);
    }
  }
  items.forEach((x,i)=>{
    const el=document.createElement('div');
    el.className='stop';
    el.innerHTML=`
      <div class="row"><b>${i+1}. ${x.name}</b> <button class="del" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button></div>
      <div class="small">üìç ${x.city}</div>
    `;
    el.querySelector('.del').onclick=()=>{ route.splice(i,1); localStorage.setItem('kk-route',JSON.stringify(route)); renderAll(); };
    box.appendChild(el);
  });
  $("#route-stats").textContent = items.length? `–¢–æ—á–µ–∫: ${items.length} ¬∑ –ü—Ä–æ—Ç—è–∂—ë–Ω–Ω–æ—Å—Ç—å ‚âà ${km(total)}` : '–ø—É—Å—Ç–æ';
}

function optimizeRoute(){
  if(route.length<3){ toast('–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 —Ç–æ—á–∫–∏'); return }
  // –∂–∞–¥–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º: —Å—Ç–∞—Ä—Ç ‚Äî 1-—è —Ç–æ—á–∫–∞, –¥–∞–ª—å—à–µ –±–ª–∏–∂–∞–π—à–∞—è
  const points=route.map(id=>ATTRACTIONS.find(x=>x.id===id));
  const used=new Set([points[0].id]); const order=[points[0]];
  while(order.length<points.length){
    const last=order[order.length-1];
    const cand=points.filter(p=>!used.has(p.id)).map(p=>({p, d:haversine(last,p)})).sort((a,b)=>a.d-b.d)[0].p;
    used.add(cand.id); order.push(cand);
  }
  const ids=order.map(x=>x.id); route.splice(0,route.length,...ids);
  localStorage.setItem('kk-route',JSON.stringify(route));
  renderAll(); toast('–ú–∞—Ä—à—Ä—É—Ç —É–ø–æ—Ä—è–¥–æ—á–µ–Ω –ø–æ –±–ª–∏–∑–æ—Å—Ç–∏');
}

function openSingleNav(x){
  const hasUser=!!userPos;
  const ym = hasUser
    ? `https://yandex.ru/maps/?rtext=${userPos.lat}%2C${userPos.lon}~${x.lat}%2C${x.lon}&rtt=auto`
    : `https://yandex.ru/maps/?ll=${x.lon}%2C${x.lat}&z=13&pt=${x.lon}%2C${x.lat},pm2rdm`;
  window.open(ym,'_blank','noopener');
}

function openRouteYMaps(){
  const items=route.map(id=>ATTRACTIONS.find(x=>x.id===id)).filter(Boolean);
  if(!items.length){ toast('–î–æ–±–∞–≤—å —Ç–æ—á–∫–∏ –≤ –º–∞—Ä—à—Ä—É—Ç'); return }
  const parts=[];
  if(userPos) parts.push(`${userPos.lat}%2C${userPos.lon}`);
  items.forEach(x=>parts.push(`${x.lat}%2C${x.lon}`));
  const url=`https://yandex.ru/maps/?rtext=${parts.join('~')}&rtt=auto`;
  window.open(url,'_blank','noopener');
}
function openRouteGMaps(){
  const items=route.map(id=>ATTRACTIONS.find(x=>x.id===id)).filter(Boolean);
  if(!items.length){ toast('–î–æ–±–∞–≤—å —Ç–æ—á–∫–∏ –≤ –º–∞—Ä—à—Ä—É—Ç'); return }
  let origin='',dest='',way=[];
  if(userPos){ origin=`${userPos.lat},${userPos.lon}`; dest=`${items.at(-1).lat},${items.at(-1).lon}`; way=items.slice(0,-1).map(x=>`${x.lat},${x.lon}`); }
  else{ origin=`${items[0].lat},${items[0].lon}`; dest=`${items.at(-1).lat},${items.at(-1).lon}`; way=items.slice(1,-1).map(x=>`${x.lat},${x.lon}`); }
  const url=`https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&travelmode=driving${way.length?`&waypoints=${way.join('|')}`:''}`;
  window.open(url,'_blank','noopener');
}

/* ------------ –®–≠–†–ò–ù–ì/–ò–ó–ë–†–ê–ù–ù–û–ï ------------ */
function applyShareFromURL(){
  const p=new URLSearchParams(location.search);
  const ids=(p.get('ids')||'').split(',').map(s=>+s).filter(Boolean);
  if(ids.length){ route.splice(0,route.length,...ids); localStorage.setItem('kk-route',JSON.stringify(route)); }
}
function shareCurrent(){
  const u=new URL(location.href);
  if(route.length) u.searchParams.set('ids', route.join(','));
  else u.searchParams.delete('ids');
  navigator.clipboard.writeText(u.toString()).then(()=>toast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞')).catch(()=>toast(u.toString()));
}
function renderFavCount(){ $("#fav-count").textContent = favs.size }

/* ------------ –ì–ï–û–ü–û–ó–ò–¶–ò–Ø ------------- */
function locate(){
  if(!navigator.geolocation){ toast('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'); return }
  navigator.geolocation.getCurrentPosition(pos=>{
    userPos={lat:pos.coords.latitude,lon:pos.coords.longitude};
    $("#near").textContent=`${userPos.lat.toFixed(3)}, ${userPos.lon.toFixed(3)}`;
    renderAll();
    toast('–ì–µ–æ–ø–æ–∑–∏—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞');
  },err=>{
    toast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é');
  },{enableHighAccuracy:true,timeout:8000,maximumAge:60000});
}

/* ------------ –†–ï–ù–î–ï–† –í–°–ï–ì–û ------------- */
function renderAll(){
  const data=filterData();
  renderList(data); renderMap(data); renderRoute(); renderFavCount();
}

/* ------------ –°–õ–£–®–ê–¢–ï–õ–ò ------------- */
buildChips();
buildMap();
applyShareFromURL();
renderAll();

$("#q").oninput=(e)=>{query=e.target.value.trim(); renderAll();}
$("#btn-reset").onclick=()=>{query=''; $("#q").value=''; activeCats.clear(); $$('#chips .chip').forEach(x=>x.classList.remove('active')); renderAll();}
$("#btn-locate").onclick=locate;
$("#radius").oninput=(e)=>{radius=+e.target.value; $("#rad-val").textContent=radius; renderAll();}
$("#sort").onchange=(e)=>{sortMode=e.target.value; renderAll();}
$("#btn-opt").onclick=optimizeRoute;
$("#btn-clear").onclick=()=>{route.splice(0,route.length); localStorage.setItem('kk-route',JSON.stringify(route)); renderAll();}
$("#btn-ymaps").onclick=openRouteYMaps;
$("#btn-gmaps").onclick=openRouteGMaps;
$("#btn-share").onclick=shareCurrent;
$("#btn-favs").onclick=()=>{
  if(!favs.size){ toast('–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º –ø—É—Å—Ç–æ'); return }
  query=''; $("#q").value='';
  activeCats.clear(); $$('#chips .chip').forEach(x=>x.classList.remove('active'));
  const prevPos=userPos; userPos=null;
  const data=ATTRACTIONS.filter(x=>favs.has(x.id)).map(x=>({...x,_d:Infinity}));
  renderList(data); renderMap(data);
  $("#near").textContent='–∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
  userPos=prevPos;
  toast('–ü–æ–∫–∞–∑–∞–Ω—ã –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –º–µ—Å—Ç–∞');
};

if(new URLSearchParams(location.search).get('ids')) toast('–ú–∞—Ä—à—Ä—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –ø–æ —Å—Å—ã–ª–∫–µ');
</script>
</body>
</html>
